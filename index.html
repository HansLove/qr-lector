<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Taloon QR Scanner</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">游댩 Digital Horoscope</div>
      <div class="subtitle">Escanea c칩digos QR para descubrir tu destino</div>
    </div>

    <div class="scanner-container">
      <div id="reader"></div>
      <div class="scanner-overlay">
        <div class="scanner-frame">
          <div class="scanner-corners top-left"></div>
          <div class="scanner-corners top-right"></div>
          <div class="scanner-corners bottom-left"></div>
          <div class="scanner-corners bottom-right"></div>
        </div>
      </div>
    </div>

    <div id="status" class="status loading">
      <span class="loading-spinner"></span>
      Inicializando c치mara...
    </div>

    <div id="resultado" class="result-container">
      <div class="result-title">QR Detectado</div>
      <div class="result-text" id="result-text"></div>
    </div>

    <div class="controls">
      <button class="btn btn-primary" id="startBtn" onclick="startScanner()">Iniciar Esc치ner</button>
      <button class="btn btn-secondary" id="stopBtn" onclick="stopScanner()" style="display: none;">Detener Esc치ner</button>
    </div>
  </div>

  <script>
    let html5QrCode;
    let isScanning = false;

    function updateStatus(message, type = 'loading') {
      const statusEl = document.getElementById('status');
      statusEl.className = `status ${type}`;
      statusEl.innerHTML = type === 'loading' ? 
        `<span class="loading-spinner"></span>${message}` : 
        message;
    }

    function showResult(text) {
      const resultEl = document.getElementById('resultado');
      const resultTextEl = document.getElementById('result-text');
      resultTextEl.textContent = text;
      resultEl.classList.add('show');
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        resultEl.classList.remove('show');
      }, 5000);
    }

    function onScanSuccess(decodedText, decodedResult) {
      if (!isScanning) return;
      
      updateStatus('춰QR detectado!', 'success');
      showResult(decodedText);
      
      // Optional: Play a success sound
      try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
        audio.play();
      } catch (e) {
        // Ignore audio errors
      }
    }

    function onScanFailure(error) {
      // Handle scan failure silently
    }

    async function startScanner() {
      if (isScanning) return;

      try {
        updateStatus('Solicitando permisos de c치mara...', 'loading');
        
        // Create Html5Qrcode instance first
        html5QrCode = new Html5Qrcode("reader");
        
        // Get available cameras
        const devices = await Html5Qrcode.getCameras();
        
        if (!devices || devices.length) {
          let cameraId = devices[0].id;
          
          const config = {
            fps: 10,
            qrbox: { width: 250, height: 250 }
          };

          await html5QrCode.start(cameraId, config, onScanSuccess, onScanFailure);
          
          isScanning = true;
          updateStatus('Esc치ner activo - Apunta la c치mara al c칩digo QR', 'success');
          
          document.getElementById('startBtn').style.display = 'none';
          document.getElementById('stopBtn').style.display = 'inline-block';
        } else {
          updateStatus('No se encontr칩 ninguna c치mara disponible', 'error');
        }
        
      } catch (error) {
        console.error('Error starting scanner:', error);
        
        // More specific error handling
        if (error.message.includes('user agent') || error.message.includes('platform')) {
          updateStatus('Permisos de c치mara denegados. Por favor, permite el acceso a la c치mara y recarga la p치gina.', 'error');
        } else if (error.message.includes('NotFoundError')) {
          updateStatus('No se encontr칩 ninguna c치mara disponible', 'error');
        } else {
          updateStatus('Error al iniciar la c치mara: ' + error.message, 'error');
        }
      }
    }

    async function stopScanner() {
      if (!isScanning || !html5QrCode) return;

      try {
        await html5QrCode.stop();
        isScanning = false;
        updateStatus('Esc치ner detenido', 'loading');
        
        document.getElementById('startBtn').style.display = 'inline-block';
        document.getElementById('stopBtn').style.display = 'none';
        
      } catch (error) {
        console.error('Error stopping scanner:', error);
      }
    }

    // Auto-start scanner when page loads
    window.addEventListener('load', () => {
      // Check if we're on a mobile device
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      if (isMobile) {
        // Auto-start on mobile devices with a longer delay to ensure page is fully loaded
        setTimeout(() => {
          updateStatus('Iniciando esc치ner autom치ticamente...', 'loading');
          startScanner();
        }, 2000);
      } else {
        updateStatus('Haz clic en "Iniciar Esc치ner" para comenzar', 'loading');
      }
    });

    // Handle page visibility changes
    document.addEventListener('visibilitychange', () => {
      if (document.hidden && isScanning) {
        stopScanner();
      }
    });
  </script>
</body>
</html>
